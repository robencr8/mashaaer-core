<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Diagnostic Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .diagnostic-section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        input, select {
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 300px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-success {
            background-color: #28a745;
        }
        .status-error {
            background-color: #dc3545;
        }
        .status-warning {
            background-color: #ffc107;
        }
        .status-info {
            background-color: #17a2b8;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>CORS Diagnostic Tool</h1>
    <p>This tool helps diagnose Cross-Origin Resource Sharing (CORS) issues with your API endpoints.</p>
    
    <div class="diagnostic-section">
        <h2>1. Browser Information</h2>
        <div id="browserInfo" class="result">Loading browser information...</div>
    </div>
    
    <div class="diagnostic-section">
        <h2>2. Current Origin</h2>
        <div id="originInfo" class="result">Loading origin information...</div>
    </div>
    
    <div class="diagnostic-section">
        <h2>3. CORS Test</h2>
        <div>
            <label for="endpointSelect">Select Endpoint:</label>
            <select id="endpointSelect">
                <option value="/api/status">API Status (/api/status)</option>
                <option value="/api/ping">API Ping (/api/ping)</option>
                <option value="/health">Health Check (/health)</option>
                <option value="/api/minimal">Minimal API (/api/minimal)</option>
                <option value="/feedback-tool-endpoint">Feedback Tool Endpoint (/feedback-tool-endpoint)</option>
                <option value="/api/feedback-tool-status">Feedback Tool Status (/api/feedback-tool-status)</option>
                <option value="/api/test-cors-minimal">Test CORS Minimal (/api/test-cors-minimal)</option>
                <option value="/minimal-test-page">Minimal Test Page (/minimal-test-page)</option>
                <option value="/feedback-tool-test">Feedback Tool Test (/feedback-tool-test)</option>
                <option value="/ultra-simple">Ultra Simple (/ultra-simple)</option>
            </select>
        </div>
        <div>
            <label for="methodSelect">HTTP Method:</label>
            <select id="methodSelect">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="OPTIONS">OPTIONS</option>
                <option value="HEAD">HEAD</option>
            </select>
        </div>
        <div>
            <label for="customHeadersInput">Custom Headers (JSON):</label>
            <input type="text" id="customHeadersInput" placeholder='{"X-Custom-Header": "value"}'>
        </div>
        <div>
            <button onclick="testCORS()">Test CORS</button>
            <button onclick="testWithCustomOrigin()">Test With Custom Origin</button>
        </div>
        <div id="corsResult" class="result">CORS test results will appear here...</div>
    </div>
    
    <div class="diagnostic-section">
        <h2>4. CORS Headers Check</h2>
        <button onclick="checkCORSHeaders()">Check CORS Headers</button>
        <div id="corsHeadersResult" class="result">CORS headers check results will appear here...</div>
    </div>
    
    <div class="diagnostic-section">
        <h2>5. Options Preflight Test</h2>
        <button onclick="testOptionsPreflight()">Test OPTIONS Preflight</button>
        <div id="optionsResult" class="result">OPTIONS preflight test results will appear here...</div>
    </div>
    
    <div class="diagnostic-section">
        <h2>6. Request/Response Details</h2>
        <button onclick="getRequestDetails()">Get Request Details</button>
        <div id="requestDetails" class="result">Request details will appear here...</div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            displayBrowserInfo();
            displayOriginInfo();
        });
        
        function displayBrowserInfo() {
            const browserInfo = document.getElementById('browserInfo');
            browserInfo.textContent = `
User Agent: ${navigator.userAgent}
Platform: ${navigator.platform}
Vendor: ${navigator.vendor}
Language: ${navigator.language}
Cookies Enabled: ${navigator.cookieEnabled}
`;
        }
        
        function displayOriginInfo() {
            const originInfo = document.getElementById('originInfo');
            originInfo.textContent = `
Location Origin: ${window.location.origin}
Protocol: ${window.location.protocol}
Hostname: ${window.location.hostname}
Port: ${window.location.port || '(default)'}
Pathname: ${window.location.pathname}
`;
        }
        
        async function testCORS() {
            const corsResult = document.getElementById('corsResult');
            const endpoint = document.getElementById('endpointSelect').value;
            const method = document.getElementById('methodSelect').value;
            let customHeaders = {};
            
            try {
                const customHeadersInput = document.getElementById('customHeadersInput').value;
                if (customHeadersInput) {
                    customHeaders = JSON.parse(customHeadersInput);
                }
            } catch (error) {
                corsResult.textContent = `Error parsing custom headers JSON: ${error.message}`;
                return;
            }
            
            corsResult.textContent = `Testing CORS for ${method} ${endpoint}...`;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const fetchOptions = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...customHeaders
                    },
                    signal: controller.signal
                };
                
                const startTime = performance.now();
                const response = await fetch(endpoint, fetchOptions);
                const endTime = performance.now();
                clearTimeout(timeoutId);
                
                const duration = Math.round(endTime - startTime);
                const corsHeaders = extractCORSHeaders(response.headers);
                
                let responseData;
                const contentType = response.headers.get('Content-Type');
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }
                
                corsResult.textContent = `
CORS Test for ${method} ${endpoint}:

Status: ${response.status} ${response.statusText}
Time: ${duration}ms
Content-Type: ${contentType || 'not specified'}

CORS Headers:
${formatCORSHeaders(corsHeaders)}

Response:
${typeof responseData === 'object' ? JSON.stringify(responseData, null, 2) : responseData}
`;
            } catch (error) {
                corsResult.textContent = `
CORS Test for ${method} ${endpoint} failed:

${error.name}: ${error.message}
`;
                
                if (error.name === 'AbortError') {
                    corsResult.textContent += '\nRequest timed out after 10 seconds.';
                }
            }
        }
        
        async function testWithCustomOrigin() {
            const corsResult = document.getElementById('corsResult');
            const endpoint = document.getElementById('endpointSelect').value;
            
            corsResult.textContent = `
Custom origin tests cannot be performed directly in the browser due to security restrictions.
To test with a custom origin, you can use tools like curl:

curl -H "Origin: https://example.com" -v ${endpoint}
`;
        }
        
        async function checkCORSHeaders() {
            const corsHeadersResult = document.getElementById('corsHeadersResult');
            const endpoint = document.getElementById('endpointSelect').value;
            
            corsHeadersResult.textContent = 'Checking CORS headers...';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'content-type',
                        'Origin': window.location.origin
                    }
                });
                
                const corsHeaders = extractCORSHeaders(response.headers);
                const issues = analyzeCORSHeaders(corsHeaders);
                
                corsHeadersResult.innerHTML = `
CORS Headers for ${endpoint}:

${formatCORSHeaders(corsHeaders)}

Analysis:
${formatCORSIssues(issues)}
`;
            } catch (error) {
                corsHeadersResult.textContent = `
Error checking CORS headers: ${error.message}
`;
            }
        }
        
        async function testOptionsPreflight() {
            const optionsResult = document.getElementById('optionsResult');
            const endpoint = document.getElementById('endpointSelect').value;
            
            optionsResult.textContent = 'Testing OPTIONS preflight...';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'content-type,authorization,x-custom-header',
                        'Origin': window.location.origin
                    }
                });
                
                const corsHeaders = extractCORSHeaders(response.headers);
                
                optionsResult.textContent = `
OPTIONS Preflight Test for ${endpoint}:

Status: ${response.status} ${response.statusText}

CORS Headers:
${formatCORSHeaders(corsHeaders)}
`;
            } catch (error) {
                optionsResult.textContent = `
OPTIONS Preflight Test failed: ${error.message}
`;
            }
        }
        
        async function getRequestDetails() {
            const requestDetails = document.getElementById('requestDetails');
            
            requestDetails.textContent = 'Getting request details...';
            
            try {
                const response = await fetch('/api/debug-request');
                const data = await response.json();
                
                requestDetails.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                requestDetails.textContent = `
Error getting request details: ${error.message}
`;
            }
        }
        
        function extractCORSHeaders(headers) {
            const corsHeaders = {};
            
            // List of common CORS-related headers
            const corsHeaderNames = [
                'Access-Control-Allow-Origin',
                'Access-Control-Allow-Methods',
                'Access-Control-Allow-Headers',
                'Access-Control-Allow-Credentials',
                'Access-Control-Expose-Headers',
                'Access-Control-Max-Age',
                'Vary'
            ];
            
            corsHeaderNames.forEach(headerName => {
                const value = headers.get(headerName);
                if (value) {
                    corsHeaders[headerName] = value;
                }
            });
            
            return corsHeaders;
        }
        
        function formatCORSHeaders(corsHeaders) {
            if (Object.keys(corsHeaders).length === 0) {
                return 'No CORS headers found.';
            }
            
            return Object.entries(corsHeaders)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');
        }
        
        function analyzeCORSHeaders(corsHeaders) {
            const issues = [];
            
            // Check Access-Control-Allow-Origin
            if (!corsHeaders['Access-Control-Allow-Origin']) {
                issues.push({
                    level: 'error',
                    header: 'Access-Control-Allow-Origin',
                    message: 'Missing required header for CORS.'
                });
            } else if (corsHeaders['Access-Control-Allow-Origin'] !== '*' && 
                       corsHeaders['Access-Control-Allow-Origin'] !== window.location.origin) {
                issues.push({
                    level: 'warning',
                    header: 'Access-Control-Allow-Origin',
                    message: `Value '${corsHeaders['Access-Control-Allow-Origin']}' may not match required origin '${window.location.origin}'`
                });
            }
            
            // Check Vary header when specific origin is used
            if (corsHeaders['Access-Control-Allow-Origin'] !== '*' && !corsHeaders['Vary']) {
                issues.push({
                    level: 'warning',
                    header: 'Vary',
                    message: 'When using specific origins, the Vary: Origin header should be included.'
                });
            }
            
            // Check Access-Control-Allow-Methods
            if (!corsHeaders['Access-Control-Allow-Methods']) {
                issues.push({
                    level: 'warning',
                    header: 'Access-Control-Allow-Methods',
                    message: 'Missing Access-Control-Allow-Methods header for preflight requests.'
                });
            }
            
            // Check Access-Control-Allow-Headers
            if (!corsHeaders['Access-Control-Allow-Headers']) {
                issues.push({
                    level: 'warning',
                    header: 'Access-Control-Allow-Headers',
                    message: 'Missing Access-Control-Allow-Headers header for preflight requests.'
                });
            }
            
            // If no issues found
            if (issues.length === 0) {
                issues.push({
                    level: 'success',
                    header: 'All Headers',
                    message: 'CORS headers appear to be properly configured.'
                });
            }
            
            return issues;
        }
        
        function formatCORSIssues(issues) {
            if (issues.length === 0) {
                return 'No issues found.';
            }
            
            return issues.map(issue => {
                const statusIndicator = `<span class="status-indicator status-${issue.level}"></span>`;
                return `${statusIndicator} ${issue.header}: ${issue.message}`;
            }).join('\n');
        }
    </script>
</body>
</html>
