<!DOCTYPE html>
<html>
<head>
    <title>CORS Test Page</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            background-color: #5c2d91;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #4a2370;
        }
        #result { 
            margin-top: 20px; 
            padding: 10px; 
            border: 1px solid #ccc; 
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #f5f5f5;
            max-height: 400px;
            overflow-y: auto;
        }
        .endpoint-selector {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #eee;
            background-color: #f9f9f9;
        }
        h1 {
            color: #5c2d91;
        }
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .request-options {
            margin-top: 20px;
        }
        select, input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .status {
            margin-top: 10px;
            font-weight: bold;
        }
        .status.success {
            color: green;
        }
        .status.error {
            color: red;
        }
        .request-details {
            margin-top: 20px;
            border: 1px solid #eee;
            padding: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>CORS Test Page</h1>
    <p>This page tests CORS configuration and helps diagnose connectivity issues.</p>

    <div class="endpoint-selector">
        <h3>Select API Endpoint</h3>
        <select id="endpointSelect">
            <option value="/api/status">GET /api/status</option>
            <option value="/api/ping">GET /api/ping</option>
            <option value="/api/minimal">GET /api/minimal</option>
            <option value="/api/test-cors">GET /api/test-cors</option>
            <option value="/test">GET /test</option>
            <option value="/feedback-tool-test">GET /feedback-tool-test</option>
            <option value="/ultra-simple">GET /ultra-simple</option>
            <option value="/api/debug-request">GET /api/debug-request</option>
        </select>
        <div class="request-options">
            <h3>Request Options</h3>
            <div>
                <label for="methodSelect">HTTP Method:</label>
                <select id="methodSelect">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="OPTIONS">OPTIONS</option>
                </select>
            </div>
            <div>
                <label for="includeCredentials">Include Credentials:</label>
                <input type="checkbox" id="includeCredentials">
            </div>
            <div>
                <label for="customOrigin">Custom Origin (leave empty for default):</label>
                <input type="text" id="customOrigin" placeholder="e.g., https://example.com">
            </div>
        </div>
    </div>

    <div class="flex-container">
        <button id="testButton">Send Request</button>
        <button id="clearButton">Clear Results</button>
    </div>

    <div class="status" id="status"></div>
    <div id="result">Results will appear here after sending a request...</div>

    <div class="request-details">
        <h3>Browser Information</h3>
        <div id="browserInfo"></div>
    </div>

    <script>
        // DOM elements
        const resultDiv = document.getElementById('result');
        const statusDiv = document.getElementById('status');
        const testButton = document.getElementById('testButton');
        const clearButton = document.getElementById('clearButton');
        const endpointSelect = document.getElementById('endpointSelect');
        const methodSelect = document.getElementById('methodSelect');
        const includeCredentials = document.getElementById('includeCredentials');
        const customOrigin = document.getElementById('customOrigin');
        const browserInfo = document.getElementById('browserInfo');

        // Browser info
        const browserInfoText = `
User Agent: ${navigator.userAgent}
Platform: ${navigator.platform}
Cookies Enabled: ${navigator.cookieEnabled}
Language: ${navigator.language}
        `;
        browserInfo.textContent = browserInfoText;

        // Clear results
        clearButton.addEventListener('click', () => {
            resultDiv.textContent = 'Results will appear here after sending a request...';
            statusDiv.textContent = '';
            statusDiv.className = 'status';
        });

        // Test API
        testButton.addEventListener('click', () => {
            const endpoint = endpointSelect.value;
            const method = methodSelect.value;
            const withCredentials = includeCredentials.checked;
            
            // Display request details
            resultDiv.textContent = `Sending ${method} request to ${endpoint}...\n`;
            resultDiv.textContent += `Include Credentials: ${withCredentials}\n`;
            
            if (customOrigin.value) {
                resultDiv.textContent += `Custom Origin: ${customOrigin.value}\n`;
            }
            
            resultDiv.textContent += '\n';

            // Building fetch options
            const fetchOptions = {
                method: method,
                credentials: withCredentials ? 'include' : 'omit',
                headers: {
                    'Accept': 'application/json, text/plain, */*'
                }
            };
            
            // Add Custom Origin header for testing (not actually used by fetch)
            if (customOrigin.value) {
                // Note: This doesn't actually change the Origin header which is controlled by the browser
                // We just log it for information purposes
                resultDiv.textContent += "Note: The Origin header can't be manually set with fetch. It's controlled by the browser.\n\n";
            }

            // For POST requests, add a body
            if (method === 'POST') {
                fetchOptions.body = JSON.stringify({
                    test: true,
                    timestamp: new Date().toISOString()
                });
                fetchOptions.headers['Content-Type'] = 'application/json';
            }

            // Make the request
            statusDiv.textContent = 'Sending request...';
            statusDiv.className = 'status';
            
            // Log request details to console for debugging
            console.log('Request URL:', endpoint);
            console.log('Request Options:', fetchOptions);

            fetch(endpoint, fetchOptions)
                .then(response => {
                    // Log the full response to console
                    console.log('Response:', response);
                    
                    // Display response details
                    statusDiv.textContent = `Status: ${response.status} ${response.statusText}`;
                    statusDiv.className = response.ok ? 'status success' : 'status error';
                    
                    // Add response headers to the output
                    resultDiv.textContent += `Response Status: ${response.status} ${response.statusText}\n\n`;
                    resultDiv.textContent += `Response Headers:\n`;
                    
                    for (const [key, value] of response.headers.entries()) {
                        resultDiv.textContent += `${key}: ${value}\n`;
                    }
                    
                    // Highlight important CORS headers
                    const corsHeaders = [
                        'access-control-allow-origin',
                        'access-control-allow-methods',
                        'access-control-allow-headers',
                        'access-control-allow-credentials',
                        'access-control-expose-headers',
                        'access-control-max-age'
                    ];
                    
                    resultDiv.textContent += '\nCORS Headers Summary:\n';
                    let foundCorsHeaders = false;
                    
                    for (const header of corsHeaders) {
                        const value = response.headers.get(header);
                        if (value) {
                            resultDiv.textContent += `${header}: ${value}\n`;
                            foundCorsHeaders = true;
                        }
                    }
                    
                    if (!foundCorsHeaders) {
                        resultDiv.textContent += 'No CORS headers found in response.\n';
                    }
                    
                    // Try to parse response as different formats
                    resultDiv.textContent += '\nResponse Body:\n';
                    
                    const contentType = response.headers.get('content-type') || '';
                    
                    if (contentType.includes('application/json')) {
                        return response.json().then(data => {
                            resultDiv.textContent += JSON.stringify(data, null, 2);
                        });
                    } else {
                        return response.text().then(text => {
                            resultDiv.textContent += text;
                        });
                    }
                })
                .catch(error => {
                    statusDiv.textContent = `Error: ${error.message}`;
                    statusDiv.className = 'status error';
                    resultDiv.textContent += `\nFetch Error: ${error.message}\n\n`;
                    resultDiv.textContent += 'This could be a CORS error or network connectivity issue.\n';
                    resultDiv.textContent += 'Check the browser console for more details.';
                    console.error('Fetch error:', error);
                });
        });
    </script>
</body>
</html>
