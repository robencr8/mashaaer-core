<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .status {
            font-style: italic;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mashaaer Server CORS Test Page</h1>
        <p>This page tests CORS connectivity to the Mashaaer server.</p>
        
        <div>
            <h2>API Endpoints:</h2>
            <button onclick="testEndpoint('/test')">Test Basic Endpoint</button>
            <button onclick="testEndpoint('/api/status')">Test API Status</button>
            <button onclick="testEndpoint('/')">Test Root</button>
            <button onclick="testOptions('/api/status')">Test OPTIONS /api/status</button>
            <button onclick="testCorsPreflightEndpoint()">Test CORS Preflight Endpoint</button>
            <button onclick="manualPreflight('/api/status')">Manual Preflight Test</button>
        </div>
        
        <div>
            <h2>Server URL:</h2>
            <input type="text" id="serverUrl" value="http://localhost:5000" style="width: 300px; padding: 5px;">
            <button onclick="updateServerUrl()">Update</button>
        </div>
        
        <div id="results">Results will appear here...</div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        let serverUrl = document.getElementById('serverUrl').value;
        
        function updateServerUrl() {
            serverUrl = document.getElementById('serverUrl').value;
            logMessage('Server URL updated to: ' + serverUrl);
        }
        
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const formattedMessage = `[${timestamp}] ${message}`;
            
            if (type === 'error') {
                resultsDiv.innerHTML += `<div class="error">${formattedMessage}</div>`;
            } else if (type === 'success') {
                resultsDiv.innerHTML += `<div class="success">${formattedMessage}</div>`;
            } else {
                resultsDiv.innerHTML += `<div class="status">${formattedMessage}</div>`;
            }
            
            // Auto-scroll to bottom
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        async function testEndpoint(endpoint) {
            const fullUrl = `${serverUrl}${endpoint}`;
            logMessage(`Testing endpoint: ${fullUrl}`);
            
            try {
                const startTime = performance.now();
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Custom-Header': 'CORS-Test'
                    }
                });
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                if (response.ok) {
                    const data = await response.json();
                    logMessage(`✅ Success! Response in ${duration}ms:`, 'success');
                    logMessage(JSON.stringify(data, null, 2));
                    
                    // Log headers
                    logMessage('Response headers:');
                    response.headers.forEach((value, key) => {
                        logMessage(`  ${key}: ${value}`);
                    });
                } else {
                    logMessage(`❌ Error: ${response.status} ${response.statusText} (${duration}ms)`, 'error');
                }
            } catch (error) {
                logMessage(`❌ Fetch error: ${error.message}`, 'error');
                logMessage('This might be a CORS issue. Check browser console for details.', 'error');
            }
        }
        
        async function testOptions(endpoint) {
            const fullUrl = `${serverUrl}${endpoint}`;
            logMessage(`Testing OPTIONS for endpoint: ${fullUrl}`);
            
            try {
                const response = await fetch(fullUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Accept': 'application/json',
                        'X-Custom-Header': 'CORS-Test',
                        'Origin': document.location.origin
                    }
                });
                
                if (response.ok) {
                    logMessage(`✅ OPTIONS request succeeded`, 'success');
                    logMessage(`Origin used: ${document.location.origin}`);
                    
                    // Log CORS headers
                    logMessage('CORS headers:');
                    const corsHeaders = [
                        'Access-Control-Allow-Origin',
                        'Access-Control-Allow-Methods',
                        'Access-Control-Allow-Headers',
                        'Access-Control-Allow-Credentials',
                        'Access-Control-Max-Age'
                    ];
                    
                    corsHeaders.forEach(header => {
                        const value = response.headers.get(header);
                        if (value) {
                            logMessage(`  ${header}: ${value}`);
                        } else {
                            logMessage(`  ${header}: <not present>`, 'error');
                        }
                    });
                } else {
                    logMessage(`❌ OPTIONS request failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                logMessage(`❌ OPTIONS request error: ${error.message}`, 'error');
                logMessage('This might be a CORS issue. Check browser console for details.', 'error');
            }
        }
        
        // Manual preflight simulation
        async function manualPreflight(endpoint) {
            const fullUrl = `${serverUrl}${endpoint}`;
            logMessage(`Performing manual preflight simulation for: ${fullUrl}`);
            
            try {
                // First, send an OPTIONS request (simulating browser preflight)
                const preflightResponse = await fetch(fullUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': document.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, X-Custom-Header'
                    }
                });
                
                if (preflightResponse.ok) {
                    logMessage(`✅ Preflight request succeeded`, 'success');
                    
                    // Log CORS headers from preflight
                    logMessage('Preflight response CORS headers:');
                    const corsHeaders = [
                        'Access-Control-Allow-Origin',
                        'Access-Control-Allow-Methods',
                        'Access-Control-Allow-Headers',
                        'Access-Control-Allow-Credentials',
                        'Access-Control-Max-Age'
                    ];
                    
                    let preflightOk = true;
                    corsHeaders.forEach(header => {
                        const value = preflightResponse.headers.get(header);
                        if (header === 'Access-Control-Allow-Origin' && value !== '*' && 
                            value !== document.location.origin) {
                            preflightOk = false;
                            logMessage(`  ❌ ${header}: ${value} (doesn't match origin)`, 'error');
                        } else if (value) {
                            logMessage(`  ✅ ${header}: ${value}`);
                        } else if (header === 'Access-Control-Allow-Origin' || 
                                  header === 'Access-Control-Allow-Methods' ||
                                  header === 'Access-Control-Allow-Headers') {
                            // These three headers are required
                            preflightOk = false;
                            logMessage(`  ❌ ${header}: <not present>`, 'error');
                        } else {
                            logMessage(`  ℹ️ ${header}: <not present>`);
                        }
                    });
                    
                    if (preflightOk) {
                        // If preflight succeeded, try the actual request
                        logMessage('Preflight successful, attempting actual request...');
                        
                        const response = await fetch(fullUrl, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Custom-Header': 'CORS-Test',
                                'Origin': document.location.origin
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            logMessage(`✅ Actual request succeeded:`, 'success');
                            logMessage(JSON.stringify(data, null, 2));
                        } else {
                            logMessage(`❌ Actual request failed: ${response.status} ${response.statusText}`, 'error');
                        }
                    } else {
                        logMessage(`❌ Preflight response missing required CORS headers`, 'error');
                    }
                } else {
                    logMessage(`❌ Preflight request failed: ${preflightResponse.status} ${preflightResponse.statusText}`, 'error');
                }
            } catch (error) {
                logMessage(`❌ Error: ${error.message}`, 'error');
                logMessage('This is likely a CORS issue. Check browser console for details.', 'error');
            }
        }
        
        async function testCorsPreflightEndpoint() {
            await testOptions('/api/cors-preflight');
        }
        
        // Automatically test the status endpoint on page load
        window.onload = function() {
            logMessage('Page loaded. Running initial tests...');
            testEndpoint('/api/status');
        };
    </script>
</body>
</html>